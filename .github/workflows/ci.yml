name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  ORT_VERSION: "1.23.2"
  ZIGMOD_VERSION: "r98"
  CACHE_VERSION: "v2"  # Bump to bust stale caches

jobs:
  # =============================================================================
  # Build and Format Check
  # =============================================================================
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            ort_artifact: onnxruntime-linux-x64
          - os: macos-14
            arch: aarch64
            ort_artifact: onnxruntime-osx-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup Zigmod
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo curl -fsSLo /usr/local/bin/zigmod https://github.com/nektro/zigmod/releases/download/${{ env.ZIGMOD_VERSION }}/zigmod-x86_64-linux
            sudo chmod +x /usr/local/bin/zigmod
          else
            sudo curl -fsSLo /usr/local/bin/zigmod https://github.com/nektro/zigmod/releases/download/${{ env.ZIGMOD_VERSION }}/zigmod-aarch64-macos
            sudo chmod +x /usr/local/bin/zigmod
          fi
          zigmod version || echo "zigmod ${{ env.ZIGMOD_VERSION }}"

      - name: Fetch zigmod dependencies
        run: zigmod fetch

      - name: Cache Zig build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            zig-cache
          key: ${{ runner.os }}-${{ matrix.arch }}-zig-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-zig-

      - name: Cache ONNX Runtime
        id: cache-ort
        uses: actions/cache@v4
        with:
          path: deps/onnxruntime
          key: ${{ matrix.ort_artifact }}-${{ env.ORT_VERSION }}-${{ env.CACHE_VERSION }}

      - name: Download ONNX Runtime
        run: |
          echo "Checking for ONNX Runtime..."
          echo "Cache hit: ${{ steps.cache-ort.outputs.cache-hit }}"
          ls -la deps/onnxruntime/ 2>/dev/null || echo "deps/onnxruntime does not exist"
          ls -la deps/onnxruntime/lib/ 2>/dev/null || echo "deps/onnxruntime/lib does not exist"

          if [ ! -f "deps/onnxruntime/lib/libonnxruntime.so" ] && [ ! -f "deps/onnxruntime/lib/libonnxruntime.dylib" ]; then
            echo "Downloading ONNX Runtime ${{ matrix.ort_artifact }}-${{ env.ORT_VERSION }}..."
            rm -rf deps/onnxruntime
            mkdir -p deps/onnxruntime
            curl -fL -o ort.tgz "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/${{ matrix.ort_artifact }}-${{ env.ORT_VERSION }}.tgz"
            tar -xzf ort.tgz --strip-components=1 -C deps/onnxruntime
            rm -f ort.tgz
            echo "Download complete. Contents:"
            ls -la deps/onnxruntime/
            ls -la deps/onnxruntime/lib/
          else
            echo "ONNX Runtime already present"
            ls -la deps/onnxruntime/lib/
          fi

      - name: Setup library paths (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/deps/onnxruntime/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Setup library paths (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/deps/onnxruntime/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Format check
        run: zig fmt --check src/ examples/

      - name: Build library
        run: zig build

      - name: Build check
        run: zig build check

  # =============================================================================
  # Unit Tests (Linux)
  # =============================================================================
  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup Zigmod
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo curl -fsSLo /usr/local/bin/zigmod https://github.com/nektro/zigmod/releases/download/${{ env.ZIGMOD_VERSION }}/zigmod-x86_64-linux
            sudo chmod +x /usr/local/bin/zigmod
          else
            sudo curl -fsSLo /usr/local/bin/zigmod https://github.com/nektro/zigmod/releases/download/${{ env.ZIGMOD_VERSION }}/zigmod-aarch64-macos
            sudo chmod +x /usr/local/bin/zigmod
          fi
          zigmod version || echo "zigmod ${{ env.ZIGMOD_VERSION }}"

      - name: Fetch zigmod dependencies
        run: zigmod fetch

      - name: Cache Zig build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            zig-cache
          key: ubuntu-x86_64-zig-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            ubuntu-x86_64-zig-

      - name: Cache ONNX Runtime
        id: cache-ort
        uses: actions/cache@v4
        with:
          path: deps/onnxruntime
          key: onnxruntime-linux-x64-${{ env.ORT_VERSION }}-${{ env.CACHE_VERSION }}

      - name: Download ONNX Runtime
        run: |
          if [ ! -f "deps/onnxruntime/lib/libonnxruntime.so" ]; then
            echo "Downloading ONNX Runtime..."
            rm -rf deps/onnxruntime
            mkdir -p deps/onnxruntime
            curl -fL -o ort.tgz "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-linux-x64-${{ env.ORT_VERSION }}.tgz"
            tar -xzf ort.tgz --strip-components=1 -C deps/onnxruntime
            rm -f ort.tgz
          fi
          ls -la deps/onnxruntime/lib/

      - name: Setup library paths
        run: |
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/deps/onnxruntime/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Run tests
        run: zig build test --summary all

  # =============================================================================
  # Unit Tests (macOS ARM64)
  # =============================================================================
  test-macos:
    name: Test (macOS ARM64)
    runs-on: macos-14
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup Zigmod
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo curl -fsSLo /usr/local/bin/zigmod https://github.com/nektro/zigmod/releases/download/${{ env.ZIGMOD_VERSION }}/zigmod-x86_64-linux
            sudo chmod +x /usr/local/bin/zigmod
          else
            sudo curl -fsSLo /usr/local/bin/zigmod https://github.com/nektro/zigmod/releases/download/${{ env.ZIGMOD_VERSION }}/zigmod-aarch64-macos
            sudo chmod +x /usr/local/bin/zigmod
          fi
          zigmod version || echo "zigmod ${{ env.ZIGMOD_VERSION }}"

      - name: Fetch zigmod dependencies
        run: zigmod fetch

      - name: Cache Zig build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            zig-cache
          key: macos-aarch64-zig-${{ hashFiles('build.zig', 'build.zig.zon') }}
          restore-keys: |
            macos-aarch64-zig-

      - name: Cache ONNX Runtime
        id: cache-ort
        uses: actions/cache@v4
        with:
          path: deps/onnxruntime
          key: onnxruntime-osx-arm64-${{ env.ORT_VERSION }}-${{ env.CACHE_VERSION }}

      - name: Download ONNX Runtime
        run: |
          if [ ! -f "deps/onnxruntime/lib/libonnxruntime.dylib" ]; then
            echo "Downloading ONNX Runtime..."
            rm -rf deps/onnxruntime
            mkdir -p deps/onnxruntime
            curl -fL -o ort.tgz "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-osx-arm64-${{ env.ORT_VERSION }}.tgz"
            tar -xzf ort.tgz --strip-components=1 -C deps/onnxruntime
            rm -f ort.tgz
          fi
          ls -la deps/onnxruntime/lib/

      - name: Setup library paths
        run: |
          echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/deps/onnxruntime/lib:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Run tests
        run: zig build test --summary all

  # =============================================================================
  # Integration Tests (with cached model)
  # =============================================================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-linux, test-macos]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup Zigmod
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo curl -fsSLo /usr/local/bin/zigmod https://github.com/nektro/zigmod/releases/download/${{ env.ZIGMOD_VERSION }}/zigmod-x86_64-linux
            sudo chmod +x /usr/local/bin/zigmod
          else
            sudo curl -fsSLo /usr/local/bin/zigmod https://github.com/nektro/zigmod/releases/download/${{ env.ZIGMOD_VERSION }}/zigmod-aarch64-macos
            sudo chmod +x /usr/local/bin/zigmod
          fi
          zigmod version || echo "zigmod ${{ env.ZIGMOD_VERSION }}"

      - name: Fetch zigmod dependencies
        run: zigmod fetch

      - name: Cache ONNX Runtime
        id: cache-ort
        uses: actions/cache@v4
        with:
          path: deps/onnxruntime
          key: onnxruntime-linux-x64-${{ env.ORT_VERSION }}-${{ env.CACHE_VERSION }}

      - name: Download ONNX Runtime
        run: |
          if [ ! -f "deps/onnxruntime/lib/libonnxruntime.so" ]; then
            echo "Downloading ONNX Runtime..."
            rm -rf deps/onnxruntime
            mkdir -p deps/onnxruntime
            curl -fL -o ort.tgz "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-linux-x64-${{ env.ORT_VERSION }}.tgz"
            tar -xzf ort.tgz --strip-components=1 -C deps/onnxruntime
            rm -f ort.tgz
          fi
          ls -la deps/onnxruntime/lib/

      - name: Cache test model
        id: cache-model
        uses: actions/cache@v4
        with:
          path: models/all-MiniLM-L6-v2
          key: model-all-MiniLM-L6-v2-v1

      - name: Download test model
        if: steps.cache-model.outputs.cache-hit != 'true'
        run: |
          pip install huggingface-hub
          mkdir -p models/all-MiniLM-L6-v2
          huggingface-cli download \
            sentence-transformers/all-MiniLM-L6-v2 \
            --local-dir models/all-MiniLM-L6-v2 \
            --include "*.json" "*.txt"
          # Download ONNX model
          huggingface-cli download \
            xenova/all-MiniLM-L6-v2 \
            onnx/model.onnx \
            --local-dir models/all-MiniLM-L6-v2

      - name: Setup library paths
        run: |
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/deps/onnxruntime/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Run integration tests
        run: zig build test-integration --summary all
